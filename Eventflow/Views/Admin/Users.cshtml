@using Eventflow.ViewModels.Admin.Component
@model ManageUsersViewModel

@{
    ViewData["Title"] = "Manage Users";
    Layout = "~/Views/Shared/_CalendarLayout.cshtml";
}

<h1 class="mb-4">Manage Users</h1>

<form method="get" class="row g-3 mb-4 align-items-end">
    <div class="col-md-4">
        <label for="search" class="form-label">Search</label>
        <input type="text" name="search" id="search" value="@Model.SearchTerm" class="form-control" placeholder="Username or email" />
    </div>
    <div class="col-md-3">
        <label for="role" class="form-label">Role</label>
        <select name="role" id="role" class="form-select">
            <option value="All" selected="@("All" == Model.SelectedRole)">All Roles</option>
            <option value="User" selected=@("User" == Model.SelectedRole)>User</option>
            <option value="Admin" selected=@("Admin" == Model.SelectedRole)>Admin</option>
        </select>
    </div>
    <div class="col-md-3">
        <label for="status" class="form-label">Status</label>
        <select name="status" id="status" class="form-select">
            <option value="All" selected=@("All" == Model.SelectedStatus)>All Statuses</option>
            <option value="Active" selected=@("Active" == Model.SelectedStatus)>Active</option>
            <option value="Banned" selected=@("Banned" == Model.SelectedStatus)>Banned</option>
        </select>
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary w-100" type="submit">Filter</button>
    </div>
</form>

<div style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6;">
    <table class="table table-hover table-bordered align-middle mb-0"
           style="width: 100%; border-collapse: collapse;">
        <thead class="table-light">
            <tr class="text-center">
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th style="width: 160px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in Model.Users)
            {
                <tr data-user-id="@user.Id">
                    <td class="username-cell">@user.Username</td>
                    <td class="email-cell">@user.Email</td>
                    <td class="role-cell text-center" style="border: 1px solid #dee2e6; text-align: center;">
                     <div class="d-flex justify-content-center align-items-center" style="min-height: 42px;">
                        <span class="badge @(user.RoleName == "Admin" ? "bg-primary" : "bg-secondary")">
                              @user.RoleName
                        </span>
                     </div>
                  </td>

                  <td style="border: 1px solid #dee2e6; text-align: center;">
                     <div class="d-flex justify-content-center align-items-center" style="min-height: 42px;">
                        <span class="badge bg-@(user.Status == "Banned" ? "danger" : "success")">
                              @user.Status
                        </span>
                     </div>
                  </td>
                    <td style="border: 1px solid #dee2e6;">
                     <div class="d-flex justify-content-center flex-wrap gap-1">
                        <!-- Edit Icon -->
                        <button type="button"
                              class="btn btn-sm btn-warning px-2 btn-edit-user"
                              title="Edit"
                              data-user-id="@user.Id"
                              data-user-username="@user.Username"
                              data-user-email="@user.Email"
                              data-user-role="@user.RoleName">
                           <i class="bi bi-pencil-fill"></i>
                        </button>

                        @if (user.RoleName != "Admin")
                        {
                              var action = user.Status == "Banned" ? "UnbanUser" : "BanUser";
                              var label = user.Status == "Banned" ? "Unban" : "Ban";
                              var icon = user.Status == "Banned" ? "bi-unlock-fill" : "bi-slash-circle-fill";
                              var css = user.Status == "Banned" ? "btn-success" : "btn-danger";

                              <button type="button"
                                    class="btn btn-sm @css px-2 btn-toggle-ban"
                                    data-user-id="@user.Id"
                                    data-user-status="@user.Status"
                                    title="@label">
                                 <i class="bi @icon"></i>
                              </button>

                              <!-- Delete Icon -->
                              <a href="@Url.Action("DeleteUser", "Admin", new { id = user.Id })"
                                 class="btn btn-sm btn-outline-danger px-2"
                                 onclick="return confirm('Are you sure you want to delete this user?');"
                                 title="Delete">
                                 <i class="bi bi-trash-fill"></i>
                              </a>
                        }
                     </div>
                  </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@Html.Partial("~/Views/Shared/Partials/Admin/User/_EditUserModalPartial.cshtml")

<script src="~/js/admin/admin_manage_users.js"></script>